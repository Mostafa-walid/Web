<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Toastify -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <title>Document</title>
  </head>
  <body>
    <div
      class="card"
      style="
        width: 30rem;
        margin: 0 auto;
        margin-top: 50px;
        margin-bottom: 100px;
      "
    >
      <div class="card-body">
        <div style="text-align: center">
          <h1>Add Car</h1>
        </div>
        <form id="Form">
          <div class="mb-3">
            <label for="type" class="form-label">Type</label>
            <input
              type="text"
              class="form-control"
              id="type"
              name="type"
              required
            />
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <input
              type="text"
              class="form-control"
              id="description"
              name="description"
              required
            />
          </div>
          <div class="mb-3">
            <label for="model" class="form-label">Model</label>
            <input
              type="text"
              class="form-control"
              id="model"
              name="model"
              required
            />
          </div>
          <div class="mb-3">
            <label for="yearOfManufacture" class="form-label"
              >Year of Manufacture</label
            >
            <input
              type="number"
              class="form-control"
              id="yearOfManufacture"
              name="yearOfManufacture"
              required
            />
          </div>
          <div class="mb-3">
            <label for="price" class="form-label">Price</label>
            <input
              type="number"
              class="form-control"
              id="price"
              name="price"
              required
            />
          </div>
          <div class="mb-3">
            <label for="horsePower" class="form-label">Horse Power</label>
            <input
              type="text"
              class="form-control"
              id="horsePower"
              name="horsePower"
              required
            />
          </div>
          <div class="mb-3">
            <label for="cylinders" class="form-label">Cylinders</label>
            <input
              type="text"
              class="form-control"
              id="cylinders"
              name="cylinders"
              required
            />
          </div>
          <div class="mb-3">
            <label for="transmission" class="form-label">Transmission</label>
            <select
              class="form-select"
              id="transmission"
              name="transmission"
              required
            >
              <option value="automatic">Automatic</option>
              <option value="manual">Manual</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="cc" class="form-label">CC</label>
            <input
              type="text"
              class="form-control"
              id="cc"
              name="cc"
              required
            />
          </div>
          <div class="mb-3">
            <label for="color" class="form-label">Color</label>
            <input
              type="text"
              class="form-control"
              id="color"
              name="color"
              required
            />
          </div>
          <div class="mb-3">
            <label for="airbags" class="form-label">Airbags</label>
            <input
              type="number"
              class="form-control"
              id="airbags"
              name="airbags"
              required
            />
          </div>
          <div class="mb-3">
            <label for="EBD" class="form-label">EBD</label>
            <select class="form-select" id="EBD" name="EBD" required>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
         </div>
          <div class="mb-3">
            <label for="ABS" class="form-label">ABS</label>
            <select class="form-select" id="ABS" name="ABS" required>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="length" class="form-label">Length</label>
            <input
              type="number"
              class="form-control"
              id="length"
              name="length"
              required
            />
          </div>
          <div class="mb-3">
            <label for="width" class="form-label">Width</label>
            <input
              type="number"
              class="form-control"
              id="width"
              name="width"
              required
            />
          </div>
          <div class="mb-3">
            <label for="height" class="form-label">Height</label>
            <input
              type="number"
              class="form-control"
              id="height"
              name="height"
              required
            />
          </div>
          <div class="mb-3">
            <label for="wheelbase" class="form-label">Wheelbase</label>
            <input
              type="number"
              class="form-control"
              id="wheelbase"
              name="wheelbase"
              required
            />
          </div>
          <div class="mb-3">
            <label for="quantity" class="form-label">Quantity</label>
            <input
              type="number"
              class="form-control"
              id="quantity"
              name="quantity"
              required
            />
          </div>
          <div class="mb-3">
            <label for="images" class="form-label">Images</label>
            <input
              type="file"
              class="form-control"
              id="images"
              name="images"
              multiple
            />
          </div>
        	<div style="text-align: left; margin-bottom: 20px"></div>
          <button type="submit" id="add_btn" class="btn btn-primary">
            Submit
          </button>
						<a
							href="/admin/<%= user._id %>/cars"
							class="btn btn-secondary"
							>Back</a
						>
					</div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies (Popper.js and jQuery) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
      import showMsg from "/js/toastify.js";

      document
        .getElementById("Form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          // document.getElementById("add_btn").disabled = true;

          const formData = new FormData(event.target);

          const type = formData.get("type");
          const description = formData.get("description");
          const model = formData.get("model");
          const yearOfManufacture = formData.get("yearOfManufacture");
          const price = formData.get("price");
          const horsePower = formData.get("horsePower");
          const cylinders = formData.get("cylinders");
          const transmission = formData.get("transmission");
          const cc = formData.get("cc");
          const color = formData.get("color");
          const airbags = formData.get("airbags");
          const EBD = formData.get("EBD");
          const ABS = formData.get("ABS");
          const length = formData.get("length");
          const width = formData.get("width");
          const height = formData.get("height");
          const wheelbase = formData.get("wheelbase");
          const quantity = formData.get("quantity");
          const images = formData.getAll("images");
         const carData = {
            type,
            description,
            model,
            yearOfManufacture,
            price,
            horsePower,
            cylinders,
            transmission,
            cc,
            color,
            airbags,
            EBD,
            ABS,
            length,
            width,
            height,
            wheelbase,
            quantity,
          };

          if (price < 0) return showMsg("price should not be negative ", "red");
          if (yearOfManufacture < 1900 || yearOfManufacture > 2025)
            return showMsg("please enter a valid year ", "red");
          if (length < 0)
            return showMsg("length should not be negative ", "red");
          if (width < 0) return showMsg("width should not be negative ", "red");
          if (height < 0)
            return showMsg("height should not be negative ", "red");
          if (quantity < 0)
            return showMsg("quantity should not be negative ", "red");
          if (wheelbase < 0)
            return showMsg("wheel Base should not be negative ", "red");
          if (airbags < 0)
            return showMsg("Air bag Base should not be negative ", "red");

          const imageFiles = Array.from(images);
          const imageUrls = await Promise.all(
            imageFiles.map(async (imageFile) => {
              const imageUrl = await uploadImage(imageFile);
              return imageUrl;
            })
          );

          carData.images = imageUrls;

          fetch("/cars", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(carData),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.errMsg) showMsg(data.errMsg, "red");
              else {
                showMsg("Car added successfully", "green");
                setTimeout(() => {
                  setTimeout(function () {
                    location.href = "/admin/<%= user._id%>/cars";
                  }, 2000);
                });
              }
            })
            .catch((error) => {
              showMsg("Error: " + error, "red");
            });
        });

      async function uploadImage(imageFile) {
        const formData = new FormData();
        formData.append("image", imageFile);

        const response = await fetch("/cars/upload", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();
        return data.imageUrl;
      }
    </script>
  </body>
</html>
